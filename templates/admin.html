{% extends "base.html" %}
{% block content %}

<div class="sidebar">
    <h2>Admin</h2>
    <a href="{{ url_for('logout') }}">Logout</a>
</div>

<div class="content">
    <h1>Admin Dashboard</h1>

    <!-- Chart -->
    <canvas id="chart"></canvas>

    <h2>Users</h2>
    <table>
        <tr>
            <th>ID</th>
            <th>Username</th>
            <th>Role</th>
            <th>Action</th>
        </tr>

        {% for user in users %}
        <tr>
            <td>{{ user.id }}</td>
            <td>
                {{ user.username }}
                {% if user.id == session['user_id'] %}
                    <span style="font-size:12px;color:#4f7cff;">(You)</span>
                {% endif %}
            </td>

            <!-- ROLE UPDATE -->
            <td>
                {% if user.id != session['user_id'] %}
                <form method="POST" action="{{ url_for('update_role', user_id=user.id) }}">
                    <select name="role" onchange="this.form.submit()">
                        <option value="admin" {% if user.role=='admin' %}selected{% endif %}>Admin</option>
                        <option value="manager" {% if user.role=='manager' %}selected{% endif %}>Manager</option>
                        <option value="user" {% if user.role=='user' %}selected{% endif %}>User</option>
                    </select>
                </form>
                {% else %}
                    {{ user.role }}
                {% endif %}
            </td>

            <!-- DELETE -->
            <td>
                {% if user.id != session['user_id'] %}
                    <button onclick="confirmDelete({{ user.id }})">Delete</button>
                {% else %}
                    <button disabled style="opacity:0.5;cursor:not-allowed;">
                        Cannot Delete Self
                    </button>
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </table>
</div>

<!-- DELETE CONFIRM MODAL -->
<div id="modal" class="modal">
    <div class="modal-content glass">
        <p>Are you sure you want to delete this user?</p>
        <form id="deleteForm" method="POST">
            <button type="submit">Yes, Delete</button>
            <button type="button" onclick="closeModal()">Cancel</button>
        </form>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
/* ================= DELETE MODAL ================= */
function confirmDelete(userId) {
    document.getElementById("modal").style.display = "flex";
    document.getElementById("deleteForm").action =
        "{{ url_for('delete_user', user_id=0) }}".replace("0", userId);
}

function closeModal() {
    document.getElementById("modal").style.display = "none";
}

/* ================= CHART ================= */
new Chart(document.getElementById('chart'), {
    type: 'bar',
    data: {
        labels: ['Admin','Manager','User'],
        datasets: [{
            label: 'User Distribution',
            data: [{{ admin_count }}, {{ manager_count }}, {{ user_count }}],
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        animation: {
            duration: 1500
        },
        plugins: {
            legend: {
                display: false
            }
        }
    }
});
</script>

{% endblock %}